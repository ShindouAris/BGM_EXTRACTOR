# ACB to MP3 Batch Converter (using vgmstream and LAME)

This Python script automates the process of converting `.acb` (Audio CriWare Binary) files into `.mp3` format. It leverages the external command-line tools `vgmstream-cli` for decoding the ACB files into temporary WAV tracks and `LAME` for encoding these WAV tracks into high-quality MP3 files.

The script recursively scans a source directory, processes each `.acb` file found, mirrors the source directory structure in the output directory, and intelligently names the resulting MP3 files, including removing common game-specific prefixes.

## Features

*   **Batch Conversion:** Processes multiple `.acb` files recursively within a source directory.
*   **External Tool Integration:** Uses `vgmstream-cli` for ACB decoding and `LAME` for MP3 encoding.
*   **Directory Mirroring:** Replicates the folder structure from the source directory into the output directory.
*   **Intelligent Output Naming:**
    *   Uses the original ACB filename base if only one track is extracted.
    *   Uses numbered filenames (e.g., `base_0.mp3`, `base_1.mp3`) if multiple tracks are extracted from a single ACB.
    *   **Prefix Removal:** Automatically removes configurable prefixes (like `vs_`, `an_`, `se_`, etc.) from the beginning of the final MP3 filenames.
*   **Customizable Paths:** Specify paths to `vgmstream-cli` and `LAME` executables.
*   **Configurable Quality:** Set LAME encoding options (defaults to high-quality VBR `-V 2`).
*   **Temporary File Management:** Creates temporary WAV files during conversion and cleans them up afterward (unless specified otherwise or an error occurs).
*   **Dry Run Mode:** Preview the commands that *would* be executed and the files that *would* be created without making any changes.
*   **Keep WAV Option:** Optionally keep the intermediate WAV files for debugging or other purposes.
*   **Error Reporting:** Provides detailed output, including errors from external tools.

## Prerequisites

1.  **Python 3.x:** Ensure you have Python 3 installed.
2.  ~~**vgmstream-cli:** You need the command-line version of vgmstream.~~
    *   ~~**Download:** Get it from the [vgmstream releases page](https://github.com/vgmstream/vgmstream/releases) (look for `vgmstream-cli` or similar in the assets, e.g., `vgmstream-win.zip` often contains `vgmstream-cli.exe` or `test.exe` which can be renamed).~~
    *  ~~ **Accessibility:** The script needs to be able to find and execute `vgmstream-cli.exe` (or the equivalent for your OS). Place it in a directory listed in your system's `PATH` environment variable, put it in the same directory as the script, or specify the full path using the `--vgmstream-path` argument.~~
3.  ~~**LAME:** You need the LAME MP3 encoder executable.~~
    *  ~~**Download:** Official LAME binaries are often found via links on the [LAME Project site](http://lame.sourceforge.net/links.php) or reputable sources like [RareWares](https://www.rarewares.org/mp3-lame-bundle.php).~~
    *   ~~**Accessibility:** Similar to vgmstream, `lame.exe` (or `lame` on Linux/macOS) must be accessible via the system `PATH`, located in the script's directory, or specified using the `--lame-path` argument.~~

## Installation

1.  Save the script code to a file, for example, `trackdecode.py`.
2.  Download `vgmstream-cli` and `LAME` (see Prerequisites) and make them accessible. You can often place them in subdirectories next to the script (e.g., `vgmstream-win64/vgmstream-cli.exe` and `Lame/lame.exe` as per the script defaults).

## Usage

Run the script from your terminal or command prompt.

**Basic Syntax:**

```bash
python trackdecode.py [options] <source_directory> <output_directory>
```

**Arguments:**

*   `source_directory`: The path to the root directory containing the `.acb` files you want to convert. The script will search recursively within this directory.
*   `output_directory`: The path to the root directory where the converted `.mp3` files will be saved. The script will create subdirectories mirroring the structure found within `source_directory`.

**Options:**

*   `--vgmstream-path PATH`: Specify the full path to the `vgmstream-cli` executable. (Default: tries to find `.\vgmstream-win64\vgmstream-cli.exe`, then checks PATH and current dir).
*   `--lame-path PATH`: Specify the full path to the `LAME` executable. (Default: tries to find `.\Lame\lame.exe`, then checks PATH and current dir).
*   `--lame-quality "OPTIONS"`: Specify the quality/encoding options for LAME, enclosed in quotes if they contain spaces. (Default: `"-V 2"`). Examples: `"-b 320"` (for CBR 320kbps), `"-V 0"` (highest quality VBR).
*   `--keep-wav`: Keep the intermediate `.wav` files generated by vgmstream. Useful for debugging.
*   `-d`, `--dry-run`: Perform a dry run. Print the commands that would be executed and simulate the process without actually running vgmstream/LAME or creating/modifying files.

**Examples:**

1.  **Convert all ACBs in `game_audio` to MP3s in `output_mp3s` (using default paths/quality):**
    ```bash
    python trackdecode.py game_audio output_mp3s
    ```

2.  **Convert ACBs, specifying paths to tools and using CBR 320kbps quality:**
    ```bash
    python trackdecode.py --vgmstream-path "C:\tools\vgmstream\vgmstream-cli.exe" --lame-path "/usr/local/bin/lame" --lame-quality "-b 320" /path/to/acb /path/to/output
    ```

3.  **Perform a dry run to see what would happen:**
    ```bash
    python trackdecode.py -d "D:\My ACBs" "D:\Converted Music"
    ```

4.  **Convert ACBs and keep the temporary WAV files:**
    ```bash
    python trackdecode.py --keep-wav source/audio destination/mp3
    ```

## Configuration (Inside the Script)

You can modify the default behavior by editing these variables near the top of the `trackdecode.py` script:

```python
# --- Default Configuration ---
DEFAULT_VGMSTREAM_EXE = r".\vgmstream-win64\vgmstream-cli.exe" # Default expected path/name
DEFAULT_LAME_EXE = r".\Lame\lame.exe"               # Default expected path/name
DEFAULT_LAME_QUALITY = "-V 2"             # Default LAME options
ACB_EXTENSION = ".acb"                    # Input file extension
PREFIXES_TO_REMOVE = ["vs_", "af_", "an_", "in_", "se_", "cl_", "collabo_es_"] # Prefixes to strip
# ---------------------------
```

*   `DEFAULT_VGMSTREAM_EXE`, `DEFAULT_LAME_EXE`: Change these if your tools are consistently located elsewhere relative to the script, or if they have different names (e.g., just `lame` on Linux). The script will still try PATH if these specific relative paths aren't found.
*   `DEFAULT_LAME_QUALITY`: Change the default MP3 encoding quality/options.
*   `PREFIXES_TO_REMOVE`: Modify this list to add or remove prefixes you want stripped from the beginning of the final MP3 filenames. The script checks for these prefixes case-insensitively and removes the *first* match it finds.

## Output File Naming Logic

1.  **Extraction:** `vgmstream-cli` extracts one or more `.wav` files into a temporary directory.
2.  **Base Name Determination:**
    *   If *only one* `.wav` file is extracted, the script uses the original `.acb` filename (without extension) as the base for the MP3 name.
    *   If *multiple* `.wav` files are extracted (e.g., `original_0.wav`, `original_1.wav`), the script uses the numbered base name from the temporary WAV file (e.g., `original_0`, `original_1`) as the base for the corresponding MP3 name.
3.  **Prefix Removal:** The script takes the base name determined above and checks if it starts with any of the strings listed in `PREFIXES_TO_REMOVE` (case-insensitive). If a match is found, that prefix is removed from the base name. Only the first matching prefix is removed.
4.  **Final MP3 Name:** The `.mp3` extension is appended to the (potentially modified) base name, and the file is saved in the corresponding mirrored output directory.

**Example:**
*   Input: `source/bgm/vs_battle_01.acb` (contains one track)
*   Temporary WAV: `temp/vs_battle_01_0.wav`
*   Base Name (single track): `vs_battle_01`
*   Prefix Removal (`vs_`): `battle_01`
*   Output: `output/bgm/battle_01.mp3`

*   Input: `source/sfx/se_menu_multi.acb` (contains multiple tracks)
*   Temporary WAVs: `temp/se_menu_multi_0.wav`, `temp/se_menu_multi_1.wav`
*   Base Names (multi-track): `se_menu_multi_0`, `se_menu_multi_1`
*   Prefix Removal (`se_`): `menu_multi_0`, `menu_multi_1`
*   Outputs: `output/sfx/menu_multi_0.mp3`, `output/sfx/menu_multi_1.mp3`

## Error Handling

*   The script checks for the existence of the source directory.
*   It attempts to locate the `vgmstream-cli` and `LAME` executables using the specified path, default paths, the system `PATH`, and the current directory. If not found, it will report an error and exit.
*   Errors during the execution of `vgmstream-cli` or `LAME` (e.g., corrupted input file, invalid options) are captured and reported, including the command's output/error streams when possible.
*   If an error occurs during the processing of an `.acb` file, the script will report the failure for that file and continue with the next (if any).
*   Failed temporary directories might be kept for inspection if `shutil.rmtree` fails or if `keep_wav` is not set and the process failed.
*   A final summary counts successful and failed ACB file conversions.
